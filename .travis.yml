language: node_js
sudo: false
node_js:
  - 8.16.2
cache: npm
install:
  - npm install -g yarn@`cat package.json | jq -r '.engines.yarn // "^1.2.1"'`
  - 'npm config set //registry.npmjs.org/:_authToken $NPM_TOKEN'
  - 'npm config set @coorpacademy:registry http://registry.npmjs.org/'
  - 'yarn config set registry https://registry.npmjs.org/'
  - yarn

stages:
  - lint
  - name: test
    if: tag IS blank AND (branch != master OR type = pull_request OR (branch = master AND commit_message !~ /^Publish$/))
  - name: deploy
    if: branch = master AND commit_message =~ /^Publish$/


jobs:
  include:
    - stage: lint
      before_script: npm run bootstrap
      script: npx lerna run lint

    - &test-job
      stage: test
      name: React components
      before_script:
        - npx lerna bootstrap --scope $PACKAGE_NAME --include-dependencies
        - npx lerna run prepare --scope $PACKAGE_NAME --include-dependencies
      script: npx lerna run test:only --since --scope $PACKAGE_NAME
      after_script: yarn codecov
      env: PACKAGE_NAME=@coorpacademy/components

    - <<: *test-job
      name: Player store
      env: PACKAGE_NAME=@coorpacademy/player-store
    - <<: *test-job
      name: Player services
      env: PACKAGE_NAME=@coorpacademy/player-services
    - <<: *test-job
      name: Player web
      env: PACKAGE_NAME=@coorpacademy/player-web
    - <<: *test-job
      name: Progression engine
      env: PACKAGE_NAME=@coorpacademy/progression-engine
    - <<: *test-job
      name: History
      env: PACKAGE_NAME=@coorpacademy/history
    - <<: *test-job
      name: Nova icons
      env: PACKAGE_NAME=@coorpacademy/nova-icons
    - <<: *test-job
      name: Redux history
      env: PACKAGE_NAME=@coorpacademy/redux-history
    - <<: *test-job
      name: Redux router
      env: PACKAGE_NAME=@coorpacademy/redux-router
    - <<: *test-job
      name: Redux task
      env: PACKAGE_NAME=@coorpacademy/redux-task
    - <<: *test-job
      name: Translate
      env: PACKAGE_NAME=@coorpacademy/translate
    - <<: *test-job
      name: Angular adapter
      env: PACKAGE_NAME=@coorpacademy/treantjs-adapter-angular
    - <<: *test-job
      name: Dust adapter
      env: PACKAGE_NAME=@coorpacademy/treantjs-adapter-dust
    - <<: *test-job
      name: Css Module Require Hook
      env: PACKAGE_NAME=@coorpacademy/css-modules-require-hook
    - <<: *test-job
      name: Webpack Config
      env: PACKAGE_NAME=@coorpacademy/webpack-config

    - stage: deploy
      name: Publish Player web
      script: skip
      env: PACKAGE_NAME=@coorpacademy/player-web
      deploy:
        provider: script
        skip_cleanup: true
        script: npm run static

    - stage: deploy
      name: Publish Player web on github pages
      script: skip
      env: PACKAGE_NAME=@coorpacademy/player-web
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GH_TOKEN
        local_dir: static

    - stage: deploy
      name: Update node
      script: skip
      env: PACKAGE_NAME=@coorpacademy/player-web
      deploy:
        provider: script
        skip_cleanup: true
        # ! FIXME: to update
        script: >-
          npm i -g @coorpacademy/update-node && update-node --nvmrc ./.nvmrc
          --package ./package.json --travis ./.travis.yml --repo_slug
          $TRAVIS_REPO_SLUG --team_reviewers $TEAM_REVIEWERS --branch
          "upgrade-nodejs" --base $TRAVIS_BRANCH --github_token $GH_TOKEN

    - stage: deploy
      name: Trigger dependant-builds
      script: skip
      env: PACKAGE_NAME=@coorpacademy/player-web
      deploy:
        provider: script
        skip_cleanup: true
        script: scripts/trigger-dependent-builds.sh
